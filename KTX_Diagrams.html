<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Biểu đồ hệ thống quản lý ký túc xá – Trường Đại học Điện Lực</title>
  <style>
    :root{--fg:#111;--muted:#444;--border:#ddd;--bg:#fff}
    html,body{background:var(--bg);color:var(--fg)}
    body{font-family:Segoe UI,Roboto,Arial,Helvetica,sans-serif;margin:24px;line-height:1.6;max-width:1100px}
    h1,h2{margin:16px 0 8px}
    h1{font-size:28px}
    h2{font-size:22px;border-bottom:1px solid var(--border);padding-bottom:4px}
    .note{color:var(--muted);font-size:14px}
    pre.mermaid{background:#fafafa;border:1px solid #eee;border-radius:6px;padding:12px;overflow:auto}
  </style>
  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: true, theme: 'default' });
  </script>
  <meta name="color-scheme" content="light" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="referrer" content="no-referrer" />
  <meta name="robots" content="noindex,nofollow" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' data: https://cdn.jsdelivr.net; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; img-src 'self' data:;" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
</head>
<body>
  <h1>Biểu đồ hệ thống quản lý ký túc xá – Trường Đại học Điện Lực</h1>
  <p class="note">Bao gồm: Use Case, Phân rã chức năng, DFD mức 0/1/2, Trình tự (Sequence), Hoạt động (Activity), và ERD (đã sửa cú pháp).</p>

  <h2>Use Case (Tổng quan)</h2>
  <pre class="mermaid">
flowchart LR
  SV["Sinh viên"]:::actor
  CB["Cán bộ KTX"]:::actor
  KT["Kế toán"]:::actor
  BT["Bảo trì"]:::actor
  BV["Bảo vệ"]:::actor
  QT["Quản trị"]:::actor

  UC_Login([Đăng nhập])
  UC_Apply([Nộp hồ sơ])
  UC_Approve([Xét duyệt])
  UC_Assign([Phân phòng/giường])
  UC_Contract([Hợp đồng])
  UC_Meter([Ghi chỉ số])
  UC_Invoice([Tính phí &amp; Hóa đơn])
  UC_Payment([Thanh toán])
  UC_Maint([Phiếu bảo trì])
  UC_Violation([Vi phạm])
  UC_Visitor([Khách/Ra vào])
  UC_Report([Báo cáo])
  UC_Admin([Quản trị])

  SV --> UC_Login
  SV --> UC_Apply
  SV --> UC_Payment

  CB --> UC_Login
  CB --> UC_Approve
  CB --> UC_Assign
  CB --> UC_Contract
  CB --> UC_Meter
  CB --> UC_Invoice
  CB --> UC_Report

  KT --> UC_Login
  KT --> UC_Invoice
  KT --> UC_Payment
  KT --> UC_Report

  BT --> UC_Login
  BT --> UC_Maint

  BV --> UC_Login
  BV --> UC_Visitor

  QT --> UC_Login
  QT --> UC_Admin
  QT --> UC_Report

  classDef actor fill:#fff,stroke:#333
  </pre>

  <h2>Phân rã chức năng</h2>
  <pre class="mermaid">
flowchart TB
  A[Quản lý Ký túc xá]:::root

  subgraph F1[Tiếp nhận &amp; xét duyệt]
    F1_1[Nộp hồ sơ]
    F1_2[Xét duyệt &amp; ưu tiên]
    F1_3[Danh sách chờ]
    F1_4[Ký hợp đồng]
    F1_5[Nhận phòng/Check-in]
  end

  subgraph F2[Quản lý phòng/giường]
    F2_1[Danh mục khu/nhà/tầng]
    F2_2[Loại phòng &amp; sức chứa]
    F2_3[Phân phòng]
    F2_4[Đổi phòng/Trả phòng]
  end

  subgraph F3[Phí &amp; thanh toán]
    F3_1[Định phí phòng &amp; dịch vụ]
    F3_2[Ghi chỉ số điện/nước]
    F3_3[Tính hóa đơn]
    F3_4[Thu/ghi nhận thanh toán]
    F3_5[Công nợ &amp; đối soát]
  end

  subgraph F4[Tài sản &amp; bảo trì]
    F4_1[Kiểm kê tài sản]
    F4_2[Phiếu bảo trì]
    F4_3[Thực hiện &amp; nghiệm thu]
  end

  subgraph F5[An ninh &amp; ra/vào]
    F5_1[Quản lý nội trú]
    F5_2[Sổ ra/vào &amp; khách]
    F5_3[Vi phạm &amp; xử lý]
  end

  subgraph F6[Quản trị &amp; báo cáo]
    F6_1[Người dùng &amp; vai trò]
    F6_2[Cấu hình]
    F6_3[Báo cáo/Phân tích]
  end

  A --- F1
  A --- F2
  A --- F3
  A --- F4
  A --- F5
  A --- F6

  classDef root fill:#fff,stroke:#333,stroke-width:2px
  </pre>

  <h2>DFD – Mức 0 (Khung cảnh)</h2>
  <pre class="mermaid">
flowchart LR
  ext_sv((Sinh viên)):::actor
  ext_cb((Cán bộ KTX)):::actor
  ext_fin((Kế toán/Tài chính \n Cổng thanh toán/Ngân hàng)):::actor
  ext_sis((SIS)):::actor
  ext_msg((Email/SMS)):::actor

  sys[[HỆ THỐNG QL KÝ TÚC XÁ]]:::system

  ext_sv -- Đơn đăng ký / Tra cứu / Thanh toán --> sys
  sys -- Thông báo / Hợp đồng / Hóa đơn / Biên lai --> ext_sv

  ext_cb -- Phê duyệt / Phân phòng / Ghi chỉ số --> sys
  sys -- Báo cáo / Danh sách --> ext_cb

  ext_fin -- Xác nhận giao dịch / Đối soát --> sys
  sys -- Yêu cầu thanh toán / Ủy nhiệm chi --> ext_fin

  ext_sis -- Thông tin SV --> sys
  sys -- Cập nhật trạng thái (tùy chọn) --> ext_sis

  sys -- Email/SMS thông báo --> ext_msg

  classDef actor fill:#fff,stroke:#333
  classDef system fill:#eef,stroke:#66f
  </pre>

  <h2>DFD – Mức 1 (Đỉnh)</h2>
  <pre class="mermaid">
flowchart TB
  D1[(D1: RESIDENTS)]
  D2[(D2: ROOMS/BEDS)]
  D3[(D3: CONTRACTS)]
  D4[(D4: INVOICES)]
  D5[(D5: PAYMENTS)]
  D6[(D6: METER_READINGS)]
  D7[(D7: MAINT_TICKETS)]
  D8[(D8: VIOLATIONS)]
  D9[(D9: VISITOR_LOG)]
  D10[(D10: USERS/ROLES)]
  D11[(D11: CONFIG/AUDIT)]

  P1[[1. Tiếp nhận &amp; xét duyệt]]
  P2[[2. Phân phòng &amp; hợp đồng]]
  P3[[3. Ghi chỉ số &amp; tính phí]]
  P4[[4. Hóa đơn &amp; thanh toán]]
  P5[[5. Bảo trì]]
  P6[[6. An ninh/Vi phạm]]
  P7[[7. Báo cáo &amp; quản trị]]

  ext_sv((SV)):::actor -->|Hồ sơ| P1
  P1 -->|Nội trú| D1
  P1 -->|Quyết định| P2

  P2 -->|Cập nhật phòng/giường| D2
  P2 -->|Hợp đồng| D3

  P3 -->|Chỉ số| D6
  P3 -->|Mục tính phí| D4

  P4 -->|Hóa đơn| D4
  P4 -->|Thanh toán| D5

  P5 -->|Phiếu| D7
  P6 -->|Vi phạm| D8
  P6 -->|Ra/vào| D9

  P7 -->|Người dùng, phân quyền| D10
  P7 -->|Cấu hình/Audit| D11

  classDef actor fill:#fff,stroke:#333
  </pre>

  <h2>DFD – Mức 2 (Phân phòng)</h2>
  <pre class="mermaid">
flowchart TB
  subgraph P2[Phân phòng &amp; hợp đồng]
    S1[Tiếp nhận yêu cầu]
    S2[Kiểm tra điều kiện / ưu tiên]
    S3[Tra cứu phòng trống]
    S4[Đề xuất giường]
    S5[Phê duyệt &amp; xác nhận]
    S6[Tạo hợp đồng &amp; đặt cọc]
    S7[Check-in]
  end

  D1[(RESIDENTS)]
  D2[(ROOMS/BEDS)]
  D3[(CONTRACTS)]

  S1 --> S2 --> S3 --> S4 --> S5 --> S6 --> S7
  S2 -->|Tra cứu| D1
  S3 -->|Tồn| D2
  S6 -->|Ghi hợp đồng| D3
  S5 -->|Giữ chỗ| D2
  S7 -->|Cập nhật trạng thái giường| D2
  </pre>

  <h2>DFD – Mức 2 (Tính phí &amp; Hóa đơn)</h2>
  <pre class="mermaid">
flowchart TB
  subgraph P34[Tính phí &amp; Hóa đơn]
    T1[Chốt kỳ &amp; chốt chỉ số]
    T2[Tính tiêu thụ điện/nước]
    T3[Tính phí phòng &amp; dịch vụ]
    T4[Lập hóa đơn kỳ]
    T5[Ghi nhận thanh toán]
    T6[Đối soát &amp; công nợ]
  end

  D3[(CONTRACTS)]
  D4[(INVOICES)]
  D5[(PAYMENTS)]
  D6[(METER_READINGS)]

  T1 --> T2 --> T3 --> T4 --> T5 --> T6
  T1 -->|Chốt số| D6
  T3 -->|Mục tính phí| D4
  T4 -->|Hóa đơn| D4
  T5 -->|Phiếu thu| D5
  </pre>

  <h2>Sơ đồ trình tự (Sequence)</h2>
  <pre class="mermaid">
sequenceDiagram
  actor CB as Cán bộ KTX
  participant UI as Form Phân phòng
  participant DB as CSDL
  CB->>UI: Nhập yêu cầu phân phòng
  UI->>DB: Tra cứu phòng/giường trống
  DB-->>UI: Danh sách gợi ý
  CB->>UI: Chọn giường &amp; xác nhận
  UI->>DB: Ghi hợp đồng + cập nhật giường
  DB-->>UI: OK
  UI-->>CB: Hoàn tất phân phòng
  </pre>

  <pre class="mermaid">
sequenceDiagram
  actor KT as Kế toán
  participant UI as Form Hóa đơn
  participant DB as CSDL
  KT->>UI: Chốt kỳ YYYYMM
  UI->>DB: Lấy chỉ số công tơ
  DB-->>UI: Chỉ số Prev/Curr
  UI->>UI: Tính tiêu thụ &amp; phí
  UI->>DB: Lập hóa đơn + chi tiết
  DB-->>UI: OK
  UI-->>KT: In/Xuất hóa đơn
  </pre>

  <pre class="mermaid">
sequenceDiagram
  actor SV as Sinh viên
  participant UI as Cổng thanh toán
  participant PAY as Cổng ngân hàng
  participant DB as CSDL
  SV->>UI: Thanh toán hóa đơn
  UI->>PAY: Tạo giao dịch
  PAY-->>UI: Kết quả giao dịch
  UI->>DB: Cập nhật phiếu thu &amp; trạng thái
  DB-->>UI: OK
  UI-->>SV: Biên lai/Thông báo
  </pre>

  <h2>Sơ đồ hoạt động (Activity)</h2>
  <pre class="mermaid">
flowchart TD
  A[Nhận hồ sơ] --> B{Đủ điều kiện?}
  B -- Không --> C[Từ chối/DS chờ]
  B -- Có --> D[Phân loại ưu tiên]
  D --> E[Đề xuất phòng/giường]
  E --> F{Còn chỗ?}
  F -- Không --> C
  F -- Có --> G[Thông báo &amp; ký hợp đồng]
  G --> H[Check-in]
  </pre>

  <pre class="mermaid">
flowchart TD
  A[Chốt kỳ hóa đơn] --> B[Khóa nhập chỉ số]
  B --> C[Lấy chỉ số Prev/Curr]
  C --> D[Tính tiêu thụ]
  D --> E[Tính phí phòng/dịch vụ]
  E --> F[Lập hóa đơn]
  F --> G[Gửi thông báo]
  G --> H[Thu tiền/Đối soát]
  </pre>

  <h2>ERD (đã sửa cú pháp Mermaid)</h2>
  <pre class="mermaid">
erDiagram
  BUILDING {
    int BuildingId
    string Code
    string Name
    string Address
  }
  ROOM_TYPE {
    int RoomTypeId
    string Code
    string Name
    int Capacity
    decimal BasePrice
  }
  ROOM {
    int RoomId
    int BuildingId
    int RoomTypeId
    string Number
    int Floor
    string Status
  }
  BED {
    int BedId
    int RoomId
    string BedNo
    string Status
  }

  RESIDENT {
    int ResidentId
    string StudentCode
    string FullName
    string Gender
    date DoB
    string Phone
    string Email
    string Department
    string Class
  }
  CONTRACT {
    int ContractId
    int ResidentId
    int BedId
    date StartDate
    date EndDate
    string Status
    decimal DepositAmount
  }

  SERVICE {
    int ServiceId
    string Code
    string Name
    string Unit
    decimal Price
  }
  UTILITY_METER {
    int MeterId
    int RoomId
    string Type
    string Serial
    bool Active
  }
  METER_READING {
    int ReadingId
    int MeterId
    string Period
    decimal PrevIndex
    decimal CurrIndex
  }

  INVOICE {
    int InvoiceId
    int ContractId
    string Period
    date IssueDate
    date DueDate
    string Status
    decimal TotalAmount
  }
  INVOICE_ITEM {
    int ItemId
    int InvoiceId
    string ItemType
    int RefId
    string Description
    decimal Qty
    decimal UnitPrice
    decimal Amount
  }
  PAYMENT {
    int PaymentId
    int InvoiceId
    date PaidDate
    string Method
    string RefNo
    decimal Amount
    string Status
  }

  ASSET {
    int AssetId
    string Code
    string Name
    string Unit
    decimal Price
  }
  ROOM_ASSET {
    int RoomId
    int AssetId
    decimal Qty
  }

  MAINTENANCE_TICKET {
    int TicketId
    int RoomId
    string ReportedBy
    date ReportedAt
    string Category
    string Content
    string Status
    decimal Cost
  }
  VIOLATION {
    int ViolationId
    int ResidentId
    date Date
    string Category
    string Detail
    decimal Penalty
    string Status
  }
  VISITOR_LOG {
    int VisitId
    int ResidentId
    int RoomId
    string VisitorName
    string IdNo
    date InAt
    date OutAt
    string Note
  }

  USER {
    int UserId
    string Username
    string FullName
    string Email
    string PasswordHash
    string Status
  }
  ROLE {
    int RoleId
    string Code
    string Name
  }
  USER_ROLE {
    int UserId
    int RoleId
  }

  BUILDING ||--o{ ROOM : has
  ROOM_TYPE ||--o{ ROOM : defines
  ROOM ||--o{ BED : contains

  RESIDENT ||--o{ CONTRACT : signs
  BED ||--o{ CONTRACT : allocated

  CONTRACT ||--o{ INVOICE : generates
  INVOICE ||--o{ INVOICE_ITEM : includes
  INVOICE ||--o{ PAYMENT : paidBy

  ROOM ||--o{ UTILITY_METER : has
  UTILITY_METER ||--o{ METER_READING : records

  ROOM ||--o{ ROOM_ASSET : equippedWith
  ASSET ||--o{ ROOM_ASSET : assigned

  ROOM ||--o{ MAINTENANCE_TICKET : raises
  RESIDENT ||--o{ VIOLATION : violates
  RESIDENT ||--o{ VISITOR_LOG : visits
  ROOM ||--o{ VISITOR_LOG : visits

  USER ||--o{ USER_ROLE : has
  ROLE ||--o{ USER_ROLE : grants
  </pre>

</body>
</html>
